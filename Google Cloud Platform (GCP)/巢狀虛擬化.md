**利用GCP建立巢狀虛擬化**
==
**1.在GCP建立一台虛擬機電腦，有兩點規定要遵守**  
(1)必須使用Linux的作業系統    
(2)機器系列不能使用E2 跟 N2D系列的   

2.開啟Cloud Shell    

3.開啟Cloud Shell終端機的「開啟編輯器」  

4.在清單的Terminal 點選 New Terminal  
在My First Project裡可以確認終端機建立計畫  
請確認 Cloud Shell 提示是否正確，  
例如  qazstuser02@cloudshell:~ (elaborate-leaf-345701)$  

5.之後輸入export vmname='mykvm(可更改)'定義虛擬機名稱  

6.gcloud compute instances export ${vmname} \  
  --destination=${vmname}.yaml \  
  --zone=asia-east1-a(自己當初設定的區域)  
匯出虛擬機設定檔  

7.tee -a ${vmname}.yaml<<EOF  
advancedMachineFeatures:  
  enableNestedVirtualization: true  
EOF  
編輯虛擬機設定檔，啟動巢狀虛擬化  

8.gcloud compute instances update-from-file ${vmname} \  
  --source=${vmname}.yaml \  
  --most-disruptive-allowed-action=RESTART \  
  --zone=asia-east1-a  
上傳虛擬機設定檔並重新啟動虛擬機  

9.kvm-ok  
重新連至 GCP 虛擬機驗證  

10.安裝KVM  
sudo apt install qemu-kvm  
sudo adduser ${USER} kvm  
sudo reboot  

11.檢查 kvm 是否正確安裝  
kvm -version  

12.「alpine 系統安裝」  
mkdir wk wk/iso wk/disk  
創建安裝目錄  
cd wk  
wget https://dl-cdn.alpinelinux.org/alpine/v3.15/releases/x86_64/alpine-virt-3.15.4-x86_64.iso   
-O iso/alpine-virt-3.15.4-x86_64.iso  
下載ISO檔案  

13.使用 qemu-img 產生 qcow2 格式的硬碟  
qemu-img create -f qcow2 disk/alpine.qcow2 10G  

14.檢查硬碟格式  
qemu-img info disk/alpine.qcow2  

15.  
sudo kvm -m 2048 \  
-cdrom iso/alpine-virt-3.15.4-x86_64.iso \  
-hda disk/alpine.qcow2 \   
-nographic   
參數說明請參考00-Linux-KVM-Overivew PPT   
                             
**無KVM開機**
==
sudo qemu-system-x86_64 -m 2048 \
-hda disk/alpine.qcow2 \
-nographic

**KVM開機**
==
sudo kvm -m 2048 \
-hda disk/alpine.qcow2 \
-nographic
「從虛擬機2返回虛擬機1」
poweroff

**刪除虛擬機2**
==
刪掉他的硬碟檔   
**「1核core最多切成4核core」**  
請將 alpine 系統 CPU 改成 2 CPUs 4 Cores 8 Threads 並開機驗證。(沒練習到)    
